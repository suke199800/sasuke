<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>정보의 궁전 & 방명록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Socket.IO 클라이언트 라이브러리 추가 -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* ... 이전 CSS 스타일 유지 ... */
        /* 새로운 방명록 글 강조 효과 (선택 사항) */
        .guestbook-entry.new-entry {
            animation: highlight 2s ease-out;
        }
        @keyframes highlight {
            0% { background-color: #d1fae5; } /* Light green */
            100% { background-color: #f9fafb; } /* Original background */
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 md:p-6 bg-gray-100">
    <div class="flex flex-col md:flex-row gap-6 w-full max-w-7xl mx-auto">
        <!-- Chat Section -->
        <div class="bg-white rounded-2xl shadow-sm w-full md:w-[45%] border border-gray-200/75 flex flex-col overflow-hidden guestbook-container">
            <!-- ... 채팅 섹션 HTML 구조 유지 ... -->
             <div class="text-center p-6 border-b border-gray-200/90 flex-shrink-0">...</div>
             <div id="chatArea" class="flex-grow">...</div>
             <div id="thinkingIndicator" class="flex-shrink-0">...</div>
             <div id="errorArea" class="flex-shrink-0"></div>
             <div id="inputArea" class="flex items-end gap-2 border-t border-gray-200/90 flex-shrink-0 p-2">...</div>
        </div>

        <!-- Guestbook Section -->
        <div class="bg-white rounded-2xl shadow-sm w-full md:w-[30%] border border-gray-200/75 flex flex-col guestbook-container">
            <h3 class="text-lg font-semibold text-gray-700 p-4 border-b text-center flex-shrink-0">방명록</h3>
            <div id="guestbookEntries">
                <!-- 초기 로딩은 서버에서, 실시간 추가는 JS로 -->
                {% if guestbook_entries %}
                    {% for entry in guestbook_entries %}
                    <div class="guestbook-entry">
                        <div>
                            <span class="name">{{ entry.name | e }}</span>
                            <span class="timestamp">{{ entry.timestamp }}</span>
                        </div>
                        <div class="message">{{ entry.message | e | replace('\n', '<br>') | safe }}</div>
                    </div>
                    {% endfor %}
                {% else %}
                    <p class="text-center text-gray-500 py-4" id="noEntriesMessage">아직 남겨진 글이 없사옵니다.</p>
                {% endif %}
            </div>
            <div id="guestbookForm" class="flex-shrink-0 p-4">
                <input type="text" id="guestbookName" placeholder="성함 (최대 50자)" maxlength="50" required> <!-- DB 크기에 맞춤 -->
                <textarea id="guestbookMessage" rows="3" placeholder="말씀을 남겨주시옵소서 (최대 1000자)" maxlength="1000" required></textarea> <!-- DB 크기에 맞춤 -->
                <button id="addEntryButton">등록하기</button>
                <div id="guestbookError"></div>
            </div>
        </div>

        <!-- Notepad Section -->
        <div class="bg-white p-6 rounded-2xl shadow-sm w-full md:w-[25%] border border-gray-200/75 flex flex-col guestbook-container md:sticky md:top-6">
             <!-- ... 메모장 HTML 구조 유지 ... -->
             <h3 class="text-sm font-medium text-gray-600 mb-3 flex items-center uppercase tracking-wider flex-shrink-0">...</h3>
             <textarea id="notepadTextarea" class="w-full h-full bg-transparent ..." placeholder="..."></textarea>
        </div>
    </div>

    <script>
        // --- DOM Elements ---
        const chatArea = document.getElementById('chatArea');
        // ... (다른 채팅 관련 요소들) ...
        const guestbookEntriesDiv = document.getElementById('guestbookEntries');
        const guestbookNameInput = document.getElementById('guestbookName');
        const guestbookMessageInput = document.getElementById('guestbookMessage');
        const addEntryButton = document.getElementById('addEntryButton');
        const guestbookErrorDiv = document.getElementById('guestbookError');
        const noEntriesMessage = document.getElementById('noEntriesMessage'); // '글 없음' 메시지 요소

        // --- State ---
        let conversationHistory = [];
        // ... (다른 채팅 관련 상태 변수들) ...

        // --- Socket.IO 연결 ---
        const socket = io(); // 서버와 Socket.IO 연결 시작

        // --- Chatbot Functions ---
        function appendMessageToUI(role, content) { /* ... 이전 코드 유지 ... */ }
        function autoResizeTextarea() { /* ... 이전 코드 유지 ... */ }
        async function sendMessage() { /* ... 이전 코드 유지 ... */ }

        // --- Guestbook Helper: 새 글 추가 ---
        function prependGuestbookEntry(entry) {
            // '글 없음' 메시지가 있다면 제거
            if (noEntriesMessage) {
                noEntriesMessage.remove();
            }

            const entryDiv = document.createElement('div');
            entryDiv.classList.add('guestbook-entry', 'new-entry'); // 새 글 강조 클래스 추가

            const safeName = entry.name.replace(/</g, "<").replace(/>/g, ">");
            const safeMessage = entry.message.replace(/</g, "<").replace(/>/g, ">");
            const safeTimestamp = entry.timestamp;

            entryDiv.innerHTML = `
                <div>
                    <span class="name">${safeName}</span>
                    <span class="timestamp">${safeTimestamp}</span>
                </div>
                <div class="message">${safeMessage.replace(/\n/g, '<br>')}</div>
            `;
            // 목록 맨 위에 추가 (prepend)
            guestbookEntriesDiv.insertBefore(entryDiv, guestbookEntriesDiv.firstChild);

            // 강조 효과를 위해 잠시 후 클래스 제거 (선택 사항)
            setTimeout(() => {
                entryDiv.classList.remove('new-entry');
            }, 2000); // 2초 후 제거
        }

        // --- Guestbook Core: 글 등록 (SocketIO 사용) ---
        async function addGuestbookEntry() {
            const name = guestbookNameInput.value.trim();
            const message = guestbookMessageInput.value.trim();
            guestbookErrorDiv.textContent = '';

            if (!name || !message) { guestbookErrorDiv.textContent = '성함과 말씀을 모두 적어주시옵소서.'; return; }
            // 길이 제한은 백엔드에서 처리하므로 JS에서는 생략 가능 (선택적)

            addEntryButton.disabled = true;
            guestbookNameInput.disabled = true;
            guestbookMessageInput.disabled = true;

            try {
                // 이제 fetch 대신 백엔드의 /guestbook POST API를 호출하여 DB에 저장 요청
                const response = await fetch('/guestbook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name, message: message }),
                });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || `등록 실패 (${response.status})`);
                }

                // 성공 시 입력 필드 비우기 (화면 업데이트는 SocketIO 이벤트가 처리)
                guestbookNameInput.value = '';
                guestbookMessageInput.value = '';
                // fetchAndDisplayGuestbook() 호출 제거!

            } catch (error) {
                console.error("방명록 등록 오류:", error);
                guestbookErrorDiv.textContent = error.message || "방명록 등록 중 오류 발생";
            } finally {
                addEntryButton.disabled = false;
                guestbookNameInput.disabled = false;
                guestbookMessageInput.disabled = false;
            }
        }

        // --- Socket.IO 이벤트 리스너 ---
        socket.on('connect', () => {
            console.log('Socket.IO 서버에 연결되었습니다.');
        });

        socket.on('disconnect', () => {
            console.log('Socket.IO 서버 연결이 끊어졌습니다.');
        });

        socket.on('new_entry', (entryData) => {
            console.log('새 방명록 수신:', entryData);
            // 새 글을 화면에 추가
            prependGuestbookEntry(entryData);
        });

        // --- Event Listeners ---
        askButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('input', autoResizeTextarea);
        messageInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }
        });
        addEntryButton.addEventListener('click', addGuestbookEntry);

        // --- Initial Setup ---
        messageInput.focus();
        autoResizeTextarea();
        // 초기 방명록 로딩은 서버 렌더링으로 처리됨.
        // 만약 페이지 로드 후 JS로 최신화하고 싶다면 아래 함수 호출 가능
        // fetchAndDisplayGuestbook(); // 이 함수는 이제 GET 요청만 함

    </script>
</body>
</html>
